name: Build Android Debug APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build & Upload Debug APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Install Android SDK (platform-tools & build-tools)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          build-tools: '33.0.2'
          target: default

      - name: Install Node dependencies (npm ci)
        run: npm ci --legacy-peer-deps

      - name: Build Android (no install)
        run: npm run build:android:unix:no-install

      - name: Upload debug APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk

  build-windows:
    name: Build & Upload Debug APK (Windows)
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Install Node dependencies (npm ci)
        run: npm ci --legacy-peer-deps

      - name: Build Android on Windows (no install)
        shell: powershell
        run: npm run build:android:no-install

      - name: Upload debug APK artifact (Windows)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk-windows
          path: android\app\build\outputs\apk\debug\app-debug.apk

  test-on-api-28-emulator:
    name: Test on Android 9 (API 28) emulator
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download debug APK artifact
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk

      - name: Start Android 9 Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          arch: x86_64
          target: google_apis
          emulator-options: '-no-window -noaudio -no-boot-anim'

      - name: Wait for device/emulator
        run: |
          adb wait-for-device
          for i in {1..30}; do
            state=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$state" = "1" ]; then
              echo "Emulator boot complete"; break
            fi
            echo "Waiting for emulator boot... ($i)"; sleep 2
          done

      - name: Install APK on emulator (fresh install)
        run: |
          ls -la
          ls -la app-debug-apk || true
          apkPath="app-debug-apk/app-debug.apk"
          if [ ! -f "$apkPath" ]; then echo "APK not found at $apkPath"; exit 1; fi
          # Ensure a fresh install so localStorage is empty
          adb uninstall com.joulehvac.app || true
          adb install -r "$apkPath"

      - name: Clear logcat
        run: adb logcat -c

      - name: Start app activity and trigger Accept (dev intent)
        run: |
          adb shell am start -n com.joulehvac.app/.MainActivity || true
          # Wait for the WebView to initialize
          sleep 6
          # Start a time-limited screenrecord on the device (auto-stops after 30s)
          adb shell "sh -c 'screenrecord --time-limit 30 /sdcard/test_run.mp4 >/dev/null 2>&1 &'" || true
          sleep 1
          # Trigger our dev-only broadcast which sets terms accepted and reloads the WebView
          adb shell am broadcast -a com.joulehvac.app.ACTION_ACCEPT_TERMS || true
          sleep 6

      - name: Check for fatal exceptions in logcat
        run: |
          if adb logcat -d | grep -i "FATAL EXCEPTION"; then
            echo "FATAL EXCEPTION detected in logcat"; adb logcat -d | tail -n 200; exit 1;
          else
            echo "No fatal exceptions detected."
          fi
      - name: Assert onboarding navigation in logcat
        run: |
            # Look for the unique onboarding navigate log
            if adb logcat -d | grep -q "JouleOnboarding:navigate"; then
              echo "Onboarding navigation detected in logcat.";
            else
              echo "Onboarding navigation not detected in logcat. Dumping last 200 logcat lines for debugging:";
              adb logcat -d | tail -n 200;
              exit 1;
            fi
      - name: Assert native injection in logcat
        run: |
            # Ensure the native injection log appears before or in addition to the navigation log
            if adb logcat -d | grep -q "JouleOnboarding:accept-terms-injected"; then
              echo "Native JS injection detected in logcat.";
            else
              echo "Native JS injection not detected in logcat. Dumping last 200 logcat lines for debugging:";
              adb logcat -d | tail -n 200;
              exit 1;
            fi
      - name: Capture screenshot and save logcat (always)
        if: ${{ always() }}
        run: |
            # Capture screenshot
            echo "Capturing screenshot"
            adb exec-out screencap -p > screenshot.png || true
            # Save logcat dump to file
            adb logcat -d > logcat.txt || true

      - name: Upload screenshot and logcat artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: emulator-test-artifacts
          path: |
            screenshot.png
            logcat.txt

      - name: Pull recorded screen video (on failure)
        if: ${{ failure() }}
        run: adb pull /sdcard/test_run.mp4 || true

      - name: Upload recorded video (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: emulator-test-video
          path: test_run.mp4
