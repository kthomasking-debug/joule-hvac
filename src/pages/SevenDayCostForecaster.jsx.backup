import React, { useState } from 'react';
import { 
  Zap, Home, Settings, DollarSign, MapPin, TrendingUp, 
  Calendar, Mountain, ChevronDown, ChevronUp, Share2, 
  AlertTriangle, HelpCircle, Thermometer, Menu, X
} from 'lucide-react';

// --- Caching constants ---
const CACHE_KEY_PREFIX = 'rate-cache-';
const CACHE_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours

// --- State-based electricity rates (¬¢/kWh converted to $/kWh) ---
// Data source: Average residential electricity rates by state
const STATE_ELECTRICITY_RATES = {
    'Hawaii': 0.3825,
    'California': 0.3011,
    'Massachusetts': 0.2674,
    'Alaska': 0.2491,
    'Maine': 0.2460,
    'Rhode Island': 0.2450,
    'Connecticut': 0.2430,
    'New York': 0.2413,
    'District of Columbia': 0.2154,
    'Vermont': 0.2150,
    'New Hampshire': 0.2149,
    'New Jersey': 0.2144,
    'Michigan': 0.1786,
    'Maryland': 0.1708,
    // Default fallback for unlisted states
    'DEFAULT': 0.15
};

// State abbreviation to full name mapping
const STATE_ABBR_MAP = {
    'HI': 'Hawaii',
    'CA': 'California',
    'MA': 'Massachusetts',
    'AK': 'Alaska',
    'ME': 'Maine',
    'RI': 'Rhode Island',
    'CT': 'Connecticut',
    'NY': 'New York',
    'DC': 'District of Columbia',
    'VT': 'Vermont',
    'NH': 'New Hampshire',
    'NJ': 'New Jersey',
    'MI': 'Michigan',
    'MD': 'Maryland'
};

// Helper function to get rate by state name (handles case-insensitive matching and abbreviations)
const getStateRate = (stateName) => {
    if (!stateName) return STATE_ELECTRICITY_RATES.DEFAULT;
    
    // Normalize state name for lookup
    const normalizedState = stateName.trim();
    
    // Check if it's an abbreviation first
    const fullName = STATE_ABBR_MAP[normalizedState.toUpperCase()];
    if (fullName && STATE_ELECTRICITY_RATES[fullName]) {
        console.log(`Matched abbreviation ${normalizedState} -> ${fullName}: $${STATE_ELECTRICITY_RATES[fullName].toFixed(3)}/kWh`);
        return STATE_ELECTRICITY_RATES[fullName];
    }
    
    // Direct match
    if (STATE_ELECTRICITY_RATES[normalizedState]) {
        console.log(`Direct match ${normalizedState}: $${STATE_ELECTRICITY_RATES[normalizedState].toFixed(3)}/kWh`);
        return STATE_ELECTRICITY_RATES[normalizedState];
    }
    
    // Case-insensitive fallback
    const stateKey = Object.keys(STATE_ELECTRICITY_RATES).find(
        key => key.toLowerCase() === normalizedState.toLowerCase()
    );
    
    if (stateKey) {
        console.log(`Case-insensitive match ${normalizedState} -> ${stateKey}: $${STATE_ELECTRICITY_RATES[stateKey].toFixed(3)}/kWh`);
        return STATE_ELECTRICITY_RATES[stateKey];
    }
    
    console.log(`No match for "${normalizedState}", using default: $${STATE_ELECTRICITY_RATES.DEFAULT.toFixed(3)}/kWh`);
    return STATE_ELECTRICITY_RATES.DEFAULT;
};

// --- Caching helpers ---
const getCacheKey = (lat, lon) => `${CACHE_KEY_PREFIX}${lat.toFixed(4)},${lon.toFixed(4)}`;

const getCachedRates = (key) => {
    try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;

        const { timestamp, data } = JSON.parse(cached);
        if (Date.now() - timestamp > CACHE_DURATION_MS) {
            localStorage.removeItem(key); // Stale, remove it
            return null;
        }
        console.log("Using cached rate data:", data);
        return data;
    } catch (error) {
        console.error("Error reading from cache:", error);
        return null;
    }
};

const setCachedRates = (key, data) => {
    try {
        const item = {
            timestamp: Date.now(),
            data,
        };
        localStorage.setItem(key, JSON.stringify(item));
    } catch (error) {
        console.error("Error writing to cache:", error);
    }
};


const SevenDayCostForecaster = () => {
    const { 
        heatLossFactor, 
        squareFeet, setSquareFeet, 
        insulationLevel, setInsulationLevel, 
        homeShape, setHomeShape, 
        ceilingHeight, setCeilingHeight,
        capacity, setCapacity, 
        efficiency, setEfficiency, 
        indoorTemp, setIndoorTemp, 
        utilityCost, setUtilityCost,
        manualTemp, setManualTemp, 
        manualHumidity, setManualHumidity,
        heatLoss, tons, compressorPower
    } = useOutletContext();
    const location = useLocation();

    const [state, dispatch] = useReducer(reducer, initialState);
    const [buildingExpanded, setBuildingExpanded] = useState(false);
    const [systemExpanded, setSystemExpanded] = useState(false);
    const [ratesExpanded, setRatesExpanded] = useState(false);
    const [showUpgradeModal, setShowUpgradeModal] = useState(false);
    const [shareMessage, setShareMessage] = useState('');
    // Prefer environment-provided key (Vite exposes env vars as import.meta.env)
    // Do NOT commit API keys to source control. If you previously hard-coded a key, remove it and create a .env file.
    const [apiKey, setApiKey] = useState(import.meta.env.VITE_NREL_API_KEY || '');
    const [eiaApiKey, setEiaApiKey] = useState(import.meta.env.VITE_EIA_API_KEY || '');
    const [utilityInfo, setUtilityInfo] = useState({ name: '', url: '' });
    const [ratesLoading, setRatesLoading] = useState(false);
    const [rateFetchDebug, setRateFetchDebug] = useState(null);
    const [suggestedRate, setSuggestedRate] = useState(null);
    const [tourActive, setTourActive] = useState(false);
    const [rateSource, setRateSource] = useState(null); // Track where the rate came from
    const [showDailyBreakdown, setShowDailyBreakdown] = useState(false);
    const [showElevationAnalysis, setShowElevationAnalysis] = useState(false);

    const [showAdvancedRates, setShowAdvancedRates] = useState(false);
    const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
    const [isFirstTimeUser, setIsFirstTimeUser] = useState(() => {
        // Check if user has completed onboarding before
        return !localStorage.getItem('hasCompletedOnboarding');
    });
    const [onboardingStep, setOnboardingStep] = useState(1);
    const [showOnboarding, setShowOnboarding] = useState(isFirstTimeUser);
    const [justFetchedWeather, setJustFetchedWeather] = useState(false);
    const [autoAdvanceOnboarding, setAutoAdvanceOnboarding] = useState(false);

    // convenience destructuring - only get page-specific state from reducer
    const { ui, location: locState, manual: reducerManual } = state;
    const { useCalculatedFactor, activeTab, breakdownView, warning, rateSchedule: reduxRateSchedule } = ui;
    const rateSchedule = reduxRateSchedule; // avoid creating a new [] each render as a destructuring default
    const { cityName, stateName, coords, locationElevation, homeElevation, foundLocationName } = locState;

    const capacities = useMemo(() => ({ 18: 1.5, 24: 2.0, 30: 2.5, 36: 3.0, 42: 3.5, 48: 4.0, 60: 5.0 }), []);

    // Use the correct heatLoss from context (already computed with building characteristics)
    const effectiveHeatLoss = useMemo(() => {
        if (useCalculatedFactor && heatLossFactor) {
            return heatLossFactor * 70; // This is already a BTU/hr value at 70F delta
        }
        return heatLoss; // Use the heatLoss from App context
    }, [useCalculatedFactor, heatLossFactor, heatLoss]);

    const getPerformanceAtTemp = useCallback((outdoorTemp, humidity) => {
        const params = { tons, indoorTemp, heatLossBtu: effectiveHeatLoss, compressorPower };
        return heatUtils.computeHourlyPerformance(params, outdoorTemp, humidity);
    }, [tons, indoorTemp, effectiveHeatLoss, compressorPower]);

    // Use the new hook to fetch forecast with cancellation support
    const { forecast: forecastData, loading: forecastLoading, error: forecastError, refetch } = useForecast(coords.latitude, coords.longitude, { enabled: !!coords });

    // sync hook results into reducer forecast state
    useEffect(() => {
        // only dispatch when external loader becomes true and our local state isn't already loading
        if (forecastLoading && !state.forecast.loading) dispatch({ type: 'FETCH_START' });
    }, [forecastLoading, state.forecast.loading]);

    useEffect(() => {
        // avoid repeatedly dispatching the same payload
        if (forecastData && state.forecast.data !== forecastData) dispatch({ type: 'FETCH_SUCCESS', payload: forecastData });
    }, [forecastData, state.forecast.data]);

    useEffect(() => {
        if (forecastError && state.forecast.error !== forecastError) dispatch({ type: 'FETCH_ERROR', error: forecastError });
    }, [forecastError, state.forecast.error]);

    // When coming from SystemPerformanceAnalyzer with calculated factor, auto-select it
    useEffect(() => {
        if (location.state?.useCalculatedFactor && heatLossFactor) {
            dispatch({ type: 'SET_UI_FIELD', field: 'useCalculatedFactor', value: true });
        }
    }, [location.state?.useCalculatedFactor, heatLossFactor]);

    // Local editable copy of TOU rates (kept in sync with ui.rateSchedule)
    const [localRates, setLocalRates] = useState(() => rateSchedule || []);

    // Sync localRates back to reducer when rateSchedule changes
    useEffect(() => {
        setLocalRates(rateSchedule || []);
    }, [rateSchedule]);

    const stateAbbrToFull = {
        AL: 'Alabama', AK: 'Alaska', AZ: 'Arizona', AR: 'Arkansas', CA: 'California', CO: 'Colorado', CT: 'Connecticut', DE: 'Delaware', FL: 'Florida', GA: 'Georgia', HI: 'Hawaii', ID: 'Idaho', IL: 'Illinois', IN: 'Indiana', IA: 'Iowa', KS: 'Kansas', KY: 'Kentucky', LA: 'Louisiana', ME: 'Maine', MD: 'Maryland', MA: 'Massachusetts', MI: 'Michigan', MN: 'Minnesota', MS: 'Mississippi', MO: 'Missouri', MT: 'Montana', NE: 'Nebraska', NV: 'Nevada', NH: 'New Hampshire', NJ: 'New Jersey', NM: 'New Mexico', NY: 'New York', NC: 'North Carolina', ND: 'North Dakota', OH: 'Ohio', OK: 'Oklahoma', OR: 'Oregon', PA: 'Pennsylvania', RI: 'Rhode Island', SC: 'South Carolina', SD: 'South Dakota', TN: 'Tennessee', TX: 'Texas', UT: 'Utah', VT: 'Vermont', VA: 'Virginia', WA: 'Washington', WV: 'West Virginia', WI: 'Wisconsin', WY: 'Wyoming', DC: 'District of Columbia'
    };
    const handleCitySearch = async () => {
        if (!cityName) return dispatch({ type: 'SET_UI_FIELD', field: 'error', value: 'Please enter a city name.' });
        dispatch({ type: 'SET_UI_FIELD', field: 'error', value: null });
        dispatch({ type: 'SET_LOCATION_FIELD', field: 'foundLocationName', value: '' });
        try {
            const input = cityName.trim();
            let cityPart, statePart;
            
            // Parse input: handle both "City, State" and "City State" formats
            if (input.includes(',')) {
                // Format: "Atlanta, Georgia" or "Atlanta, GA"
                [cityPart, statePart] = input.split(',').map(s => s.trim());
            } else {
                // Format: "Atlanta Georgia" or "Atlanta GA" (no comma)
                const parts = input.split(/\s+/);
                if (parts.length > 1) {
                    const lastWord = parts[parts.length - 1];
                    // Only treat as state if it's a known abbreviation or full state name
                    const isKnownState = stateAbbrToFull[lastWord.toUpperCase()] || 
                                        Object.values(stateAbbrToFull).some(s => s.toLowerCase() === lastWord.toLowerCase());
                    
                    if (isKnownState) {
                        statePart = lastWord;
                        cityPart = parts.slice(0, -1).join(' ');
                    } else {
                        // Not a known state, treat entire input as city name
                        cityPart = input;
                    }
                } else {
                    cityPart = input;
                }
            }
            
            // Normalize state to full name if it's an abbreviation
            if (statePart) {
                const abbr = statePart.toUpperCase();
                statePart = stateAbbrToFull[abbr] || statePart;
            }

            try {
                // Always search with city name only first (API works better with just city)
                let geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityPart)}&count=10&language=en&format=json`);
                let geoData = await geoResponse.json();

                if (!geoResponse.ok) throw new Error("Failed to fetch location data.");
                if (!geoData.results || geoData.results.length === 0) throw new Error(`Could not find location: "${input}"`);

                // If state was provided, filter results to that state
                let bestResult;
                if (statePart) {
                    const stateMatches = geoData.results.filter(r => 
                        (r.admin1 || '').toLowerCase() === statePart.toLowerCase() ||
                        (r.country || '').toLowerCase().includes('united states')
                    );
                    bestResult = stateMatches.length > 0 ? stateMatches[0] : geoData.results[0];
                } else {
                    // Prefer US results when no state specified
                    const usResults = geoData.results.filter(r => (r.country || '').toLowerCase().includes('united states'));
                    bestResult = usResults.length > 0 ? usResults[0] : geoData.results[0];
                }

                const elevationInFeet = Math.round(bestResult.elevation * 3.28084);
                dispatch({ type: 'SET_LOCATION_COORDS', payload: { latitude: bestResult.latitude, longitude: bestResult.longitude } });
                dispatch({ type: 'SET_LOCATION_FIELD', field: 'locationElevation', value: elevationInFeet });
                dispatch({ type: 'SET_LOCATION_FIELD', field: 'homeElevation', value: elevationInFeet });
                dispatch({ type: 'SET_LOCATION_FIELD', field: 'foundLocationName', value: `${bestResult.name}, ${bestResult.admin1 || ''}, ${bestResult.country} (Elev: ${elevationInFeet} ft)` });
                
                // Save location to localStorage for other tools
                localStorage.setItem('userLocation', JSON.stringify({
                    city: bestResult.name,
                    state: bestResult.admin1 || '',
                    latitude: bestResult.latitude,
                    longitude: bestResult.longitude,
                    elevation: elevationInFeet
                }));
                
                // Store state name for later use
                if (bestResult.admin1) {
                    dispatch({ type: 'SET_LOCATION_FIELD', field: 'stateName', value: bestResult.admin1 });
                    
                    // Auto-set electricity rate based on detected state
                    const stateRate = getStateRate(bestResult.admin1);
                    setUtilityCost(stateRate);
                    console.log(`Auto-set electricity rate for ${bestResult.admin1}: $${stateRate.toFixed(3)}/kWh`);
                }
                
                setJustFetchedWeather(true); // Mark that user just fetched new weather data
            } catch (err) {
                dispatch({ type: 'SET_UI_FIELD', field: 'error', value: err.message });
            }
        } catch (err) {
            dispatch({ type: 'SET_UI_FIELD', field: 'error', value: err.message });
        }
    };

    const handleLocationRequest = async () => {
        dispatch({ type: 'SET_UI_FIELD', field: 'error', value: null });
        if (!navigator.geolocation) {
            dispatch({ type: 'SET_UI_FIELD', field: 'error', value: 'Geolocation is not supported by your browser.' });
            return;
        }
        dispatch({ type: 'SET_LOCATION_FIELD', field: 'foundLocationName', value: 'Fetching location...' });
        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
            });
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Reverse geocode to get city/state
            const reverseGeoResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
            if (!reverseGeoResponse.ok) throw new Error('Could not fetch location name.');
            const reverseGeoData = await reverseGeoResponse.json();
            const city = reverseGeoData.city || reverseGeoData.locality || '';
            const state = reverseGeoData.principalSubdivision || 'Unknown State'; // Fallback for missing state

            dispatch({ type: 'SET_LOCATION_FIELD', field: 'cityName', value: city });
            dispatch({ type: 'SET_LOCATION_FIELD', field: 'stateName', value: state });

            if (!state || state === 'Unknown State') {
                console.warn('State information is missing or incomplete.');
            }

            // Fetch elevation
            const elevationResponse = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`);
            if (!elevationResponse.ok) throw new Error('Could not fetch elevation data.');
            const elevationData = await elevationResponse.json();
            const elevationInFeet = Math.round(elevationData.elevation[0] * 3.28084);

            dispatch({ type: 'SET_LOCATION_FIELD', field: 'locationElevation', value: elevationInFeet });
            dispatch({ type: 'SET_LOCATION_FIELD', field: 'homeElevation', value: elevationInFeet });

            const locationName = [city, state, reverseGeoData.countryName].filter(Boolean).join(', ');
            dispatch({ type: 'SET_LOCATION_FIELD', field: 'foundLocationName', value: `${locationName} (Elev: ${elevationInFeet} ft)` });
            dispatch({ type: 'SET_LOCATION_COORDS', payload: { latitude: lat, longitude: lon } });
            
            // Save location to localStorage for other tools
            localStorage.setItem('userLocation', JSON.stringify({
                city: city,
                state: state,
                latitude: lat,
                longitude: lon,
                elevation: elevationInFeet
            }));
            
            // Auto-set electricity rate based on detected state
            if (state && state !== 'Unknown State') {
                const stateRate = getStateRate(state);
                setUtilityCost(stateRate);
                console.log(`Auto-set electricity rate for ${state}: $${stateRate.toFixed(3)}/kWh`);
            }
            
            setJustFetchedWeather(true);
        } catch (err) {
            dispatch({ type: 'SET_UI_FIELD', field: 'error', value: `Could not access your location. ${err.message || ''}` });
            dispatch({ type: 'SET_LOCATION_FIELD', field: 'foundLocationName', value: '' }); // Clear loading message on error
        }
    };

    const handleFetchRates = async () => {
        if (ratesLoading) return;

        if (!apiKey) {
        dispatch({ type: 'SET_UI_FIELD', field: 'error', value: 'Please enter an NREL API key to fetch rates.' });
        dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: null });
            return;
        }
        if (!coords.latitude || !coords.longitude) {
            dispatch({ type: 'SET_UI_FIELD', field: 'error', value: 'Please set a location first.' });
            return;
        }

        dispatch({ type: 'SET_UI_FIELD', field: 'error', value: null });
        dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: null });
        setRatesLoading(true);
        setSuggestedRate(null);

        const cacheKey = getCacheKey(coords.latitude, coords.longitude);
        const cachedData = getCachedRates(cacheKey);

        if (cachedData) {
            // This function will process the data, whether it's from cache or a new fetch
            processRateData(cachedData.result, cachedData.source);
            setRatesLoading(false);
            return;
        }

        try {
            const result = await fetchRates(apiKey, coords.latitude, coords.longitude);
            processRateData(result, 'nrel');
            // Cache the successful NREL result
            if (result?.parsed) {
                setCachedRates(cacheKey, { result, source: 'nrel' });
            }
        } catch (err) {
            dispatch({ type: 'SET_UI_FIELD', field: 'error', value: `Failed to fetch rates: ${err.message}` });
            setRateFetchDebug({ parsed: null, raw: err.message || String(err) });
        } finally {
            setRatesLoading(false);
        }
    };

    // This new function centralizes the logic for processing rate data
    const processRateData = async (result, source) => {
        const { parsed, raw } = result || {};
        setRateFetchDebug({ parsed, raw });

        if (parsed) {
            // Update flat rate if valid
            if (parsed.flatRate && parsed.flatRate > 0) {
                setUtilityCost(parsed.flatRate);
                setRateSource({ type: 'nrel', utility: parsed.utilityName });
            }

            // Transform and update TOU rates
            const transformedRates = (parsed.touRates || []).map((r, i) => ({
                id: `${r.label}-${i}`,
                name: r.label,
                start: `${String(r.startHour).padStart(2, '0')}:00`,
                end: `${String(r.endHour).padStart(2, '0')}:00`,
                price: r.rate,
                days: r.type === 'weekday' ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'] : (r.type === 'weekend' ? ['Sat', 'Sun'] : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']),
            }));
            setLocalRates(transformedRates);
            dispatch({ type: 'SET_UI_FIELD', field: 'rateSchedule', value: transformedRates });
            setUtilityInfo({ name: parsed.utilityName, url: parsed.url });

            if (parsed.outdated) {
                dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: `Rate data appears outdated (last known end: ${parsed.lastKnownEnd ? new Date(parsed.lastKnownEnd).toLocaleDateString() : 'unknown'}). Using it as a fallback.` });
                const suggestion = getSuggestedRate(parsed.utilityName);
                if (suggestion) setSuggestedRate(suggestion);
            }
        } else {
            // NREL fetch failed or found nothing, try EIA fallback
            if (!eiaApiKey) {
                dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: 'Couldn\'t find utility-specific rates. Add an EIA API key to get your state\'s average rate instead.' });
                return;
            }
            if (!stateName) {
                dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: 'Couldn\'t find utility-specific rates. Search for your location first, then we can fetch your state\'s average rate.' });
                return;
            }

            try {
                const eiaResult = await fetchStateAverageRate(eiaApiKey, stateName);
                if (eiaResult && eiaResult.rate > 0) {
                    setUtilityCost(eiaResult.rate);
                    setRateSource({ type: 'eia', state: stateName, period: eiaResult.period });
                    setLocalRates([]); // Clear any old TOU rates
                    dispatch({ type: 'SET_UI_FIELD', field: 'rateSchedule', value: [] });
                    dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: `Using EIA state-average rate for ${stateName} of $${eiaResult.rate.toFixed(3)}/kWh (from ${eiaResult.period}).` });
                    setUtilityInfo({ name: `EIA Average (${stateName})`, url: 'https://www.eia.gov/electricity/data/browser/' });
                    
                    // Cache the successful EIA result
                    const cacheKey = getCacheKey(coords.latitude, coords.longitude);
                    setCachedRates(cacheKey, { result: { parsed: { flatRate: eiaResult.rate, utilityName: `EIA Average (${stateName})` } }, source: 'eia' });

                } else {
                    dispatch({ type: 'SET_UI_FIELD', field: 'warning', value: 'No usable rate data was found from NREL or EIA for this location. Defaulting to the national average rate of $0.15/kWh.' });
                    setRateSource({ type: 'default' });
                    setUtilityInfo({ name: 'National Average', url: '' });
                    const nationalAverageRate = 0.15; // Default rate in $/kWh
                    setUtilityCost(nationalAverageRate);
                }
            } catch (eiaErr) {
                dispatch({ type: 'SET_UI_FIELD', field: 'error', value: `NREL fetch failed, and EIA fallback also failed: ${eiaErr.message}` });
                setUtilityInfo({ name: '', url: '' });
            }
        }
    };

    const handleApplySuggestion = useCallback(() => {
        if (!suggestedRate) return;
        setUtilityCost(suggestedRate);
        // Clear TOU schedule if it came from outdated data
        setLocalRates([]);
        dispatch({ type: 'SET_UI_FIELD', field: 'rateSchedule', value: [] });
        setSuggestedRate(null);
        // Provide transient confirmation
        setShareMessage(`Applied suggested flat rate $${suggestedRate.toFixed(2)}/kWh`);
        setTimeout(() => setShareMessage(''), 3000);
    }, [suggestedRate, dispatch, setLocalRates]);

    const adjustedForecast = useMemo(() => {
        if (!forecastData) return null;
        return heatUtils.adjustForecastForElevation(forecastData, homeElevation, locationElevation);
    }, [forecastData, homeElevation, locationElevation]);

    useEffect(() => {
        const incoming = rateSchedule || [];
        try {
            const prevJson = JSON.stringify(localRates || []);
            const nextJson = JSON.stringify(incoming);
            if (prevJson !== nextJson) setLocalRates(incoming);
        } catch {
            if ((localRates || []).length !== incoming.length) setLocalRates(incoming);
        }
        // include localRates so comparison stays accurate when it changes externally
    }, [rateSchedule, localRates]);

    const weeklyMetrics = useMemo(() => {
        return heatUtils.computeWeeklyMetrics(adjustedForecast, getPerformanceAtTemp, utilityCost, indoorTemp, localRates);
    }, [adjustedForecast, getPerformanceAtTemp, utilityCost, indoorTemp, localRates]);

    // Persist last forecast summary for home dashboard
    useEffect(() => {
        if (weeklyMetrics && foundLocationName) {
            try {
                const payload = {
                    location: foundLocationName,
                    totalHPCost: weeklyMetrics.totalCost,
                    totalGasCost: null, // 7-Day Forecaster doesn't calculate gas cost
                    totalSavings: null,
                    estimatedAnnualSavings: null,
                    timestamp: Date.now()
                };
                localStorage.setItem('last_forecast_summary', JSON.stringify(payload));
            } catch (e) { /* ignore persistence errors */ }
        }
    }, [weeklyMetrics, foundLocationName]);

    const manualDayMetrics = useMemo(() => {
        const perf = getPerformanceAtTemp(manualTemp, manualHumidity);
        const hourlyEnergy = perf.electricalKw * (perf.runtime / 100);
        return { dailyEnergy: hourlyEnergy * 24, dailyCost: hourlyEnergy * 24 * utilityCost };
    }, [manualTemp, manualHumidity, getPerformanceAtTemp, utilityCost]);

    // --- STEP 2: CALCULATE DATA FOR THE GRAPH ---
    const elevationCostData = useMemo(() => {
        if (!forecastData) return null;

        const results = [];
        const baseElevation = Math.round(locationElevation / 500) * 500;
        const startElevation = Math.max(0, baseElevation - 2000);
        const endElevation = baseElevation + 4000;

            for (let elev = startElevation; elev <= endElevation; elev += 500) {
            const tempAdjustedForecast = heatUtils.adjustForecastForElevation(forecastData, elev, locationElevation);

            let totalCostWithAux = 0;
            tempAdjustedForecast.forEach(hour => {
                const perf = getPerformanceAtTemp(hour.temp, hour.humidity);
                const energyForHour = perf.electricalKw * (perf.runtime / 100);
                const auxEnergyForHour = perf.auxKw;
                // use localRates when calculating elevation cost
                const dt = hour.time instanceof Date ? hour.time : new Date(hour.time);
                const rate = computeHourlyRate(dt, localRates, utilityCost);
                totalCostWithAux += (energyForHour + auxEnergyForHour) * rate;
            });
            results.push({ elevation: elev, cost: parseFloat(totalCostWithAux.toFixed(2)) });
        }
        return results;
    }, [forecastData, locationElevation, getPerformanceAtTemp, utilityCost, localRates]);

    // --- Aux heat usage percentage ---
    const auxPercentage = useMemo(() => {
        if (!weeklyMetrics) return 0;
        const totalAux = weeklyMetrics.summary.reduce((acc, d) => acc + d.auxEnergy, 0);
        const totalEnergy = weeklyMetrics.summary.reduce((acc, d) => acc + d.energyWithAux, 0);
        return totalEnergy > 0 ? (totalAux / totalEnergy) * 100 : 0;
    }, [weeklyMetrics]);

    // --- Upgrade scenario calculation ---
    const upgradeScenario = useMemo(() => {
        if (!adjustedForecast) return null;
        const upgradedCapacity = capacity + 6; // e.g., 24k -> 30k
        const upgradedEfficiency = Math.min(efficiency + 2, 22); // e.g., 15 SEER2 -> 17 SEER2
        const upgradedTons = capacities[upgradedCapacity] || tons;
        const upgradedCompressorPower = upgradedTons * 1.0 * (15 / upgradedEfficiency);
        
        const getUpgradedPerformance = (outdoorTemp, humidity) => {
            const params = { tons: upgradedTons, indoorTemp, heatLossBtu: heatLoss, compressorPower: upgradedCompressorPower };
            return heatUtils.computeHourlyPerformance(params, outdoorTemp, humidity);
        };
        
        const upgraded = heatUtils.computeWeeklyMetrics(adjustedForecast, getUpgradedPerformance, utilityCost, indoorTemp, localRates);
        return {
            capacity: upgradedCapacity,
            efficiency: upgradedEfficiency,
            tons: upgradedTons,
            metrics: upgraded,
            currentCost: breakdownView === 'withAux' ? (weeklyMetrics?.totalCostWithAux || 0) : (weeklyMetrics?.totalCost || 0),
            upgradedCost: breakdownView === 'withAux' ? (upgraded?.totalCostWithAux || 0) : (upgraded?.totalCost || 0),
        };
    }, [adjustedForecast, capacity, efficiency, tons, heatLoss, indoorTemp, utilityCost, localRates, weeklyMetrics, breakdownView, capacities]);

    // --- ROI calculation (annual savings vs gas heat baseline) ---
    const roiData = useMemo(() => {
        if (!weeklyMetrics) return null;
        const currentWeeklyCost = breakdownView === 'withAux' ? weeklyMetrics.totalCostWithAux : weeklyMetrics.totalCost;
        const annualHeatPumpCost = currentWeeklyCost * (365 / 7);

        // Baseline: gas heat (e.g., 100,000 BTU/therm, 90% efficient)
        const gasEfficiency = 0.9; // 90% efficiency
        const btuPerTherm = 100000; // 1 therm = 100,000 BTU
        let baselineWeeklyCost = 0;
        if (adjustedForecast) {
            adjustedForecast.forEach(hour => {
                const tempDiff = Math.max(1, indoorTemp - hour.temp);
                const btuLossPerDegreeF = heatLoss / 70;
                const buildingHeatLossBtu = btuLossPerDegreeF * tempDiff;
                const thermsUsed = buildingHeatLossBtu / (btuPerTherm * gasEfficiency);
                const dt = hour.time instanceof Date ? hour.time : new Date(hour.time);
                const cost = thermsUsed * computeHourlyRate(dt, localRates, utilityCost);
                baselineWeeklyCost += cost;
            });
        }
        const annualGasCost = baselineWeeklyCost * (365 / 7);
        const annualSavings = annualGasCost - annualHeatPumpCost;

        return {
            annualHeatPumpCost,
            annualGasCost,
            annualSavings,
            savingsPercent: annualGasCost > 0 ? (annualSavings / annualGasCost) * 100 : 0,
        };
    }, [weeklyMetrics, breakdownView, adjustedForecast, indoorTemp, heatLoss, utilityCost, localRates]);

    // --- Share handler ---
    const handleShare = useCallback(() => {
        const params = new URLSearchParams({
            lat: coords.latitude.toFixed(4),
            lon: coords.longitude.toFixed(4),
            cap: capacity,
            eff: efficiency,
            temp: indoorTemp,
            cost: utilityCost,
        });
        const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        navigator.clipboard.writeText(shareUrl).then(() => {
            setShareMessage('Link copied to clipboard!');
            setTimeout(() => setShareMessage(''), 3000);
        }).catch(() => {
            setShareMessage('Share URL: ' + shareUrl);
        });
    }, [coords, capacity, efficiency, indoorTemp, utilityCost]);

    // --- Load params on mount (simple version) ---
    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('lat') && params.has('lon')) {
            const lat = parseFloat(params.get('lat'));
            const lon = parseFloat(params.get('lon'));
            if (!isNaN(lat) && !isNaN(lon)) {
                dispatch({ type: 'SET_LOCATION_COORDS', payload: { latitude: lat, longitude: lon } });
            }
        }
        if (params.has('cap')) {
            const cap = Number(params.get('cap'));
            if (capacities[cap]) dispatch({ type: 'SET_UI_FIELD', field: 'capacity', value: cap });
        }
        if (params.has('eff')) {
            const eff = Number(params.get('eff'));
            if (eff >= 14 && eff <= 22) dispatch({ type: 'SET_UI_FIELD', field: 'efficiency', value: eff });
        }
        if (params.has('temp')) {
            const temp = Number(params.get('temp'));
            if (temp >= 65 && temp <= 75) dispatch({ type: 'SET_UI_FIELD', field: 'indoorTemp', value: temp });
        }
        if (params.has('cost')) {
            const cost = Number(params.get('cost'));
            if (cost >= 0.05 && cost <= 0.50) setUtilityCost(cost);
        }
    }, [capacities]);


    const steps = [
        {
            target: '.seven-day-cost-forecaster',
            content: 'Welcome to the 7-Day Cost Forecaster! This tool helps you estimate your heat pump operating costs based on actual weather forecasts.',
            disableBeacon: true,
            placement: 'center',
            spotlightClicks: true,
        },
        {
            target: '#rates-section-heading',
            content: 'Configure your electricity rates here. You can use a simple flat rate or set up time-of-use pricing for more accurate estimates.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: 'button[aria-label="Fetch rates for location"]',
            content: 'For advanced users: Auto-fetch your utility rates using free API keys. This is optional‚Äîmost users can just use a manual flat rate.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '#quick-rate-presets',
            content: 'Use these quick presets to add common rate periods like summer peak hours or weekend off-peak rates in seconds.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '#city-input',
            content: 'Simply enter your city and state in one field (e.g., "Denver, CO") to load the 7-day weather forecast.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: 'button[aria-label="Use current location"]',
            content: 'Or click here to use your device\'s GPS for automatic location detection.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '#elevation',
            content: 'Adjust your home\'s elevation for more accurate air density calculations, which affect heat pump performance.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '#weekly-energy-card',
            content: 'Once you search for a location, your estimated weekly energy consumption will appear here with larger, easier-to-read numbers.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '#weekly-cost-card',
            content: 'And your total estimated weekly cost will be shown here in a prominent, easy-to-understand format.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: 'th.cursor-pointer',
            content: 'Click any column header in the daily breakdown to sort by that value‚Äîfind your most expensive days or highest energy usage at a glance.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '.lucide-help-circle',
            content: 'Hover over these help icons to see plain-language explanations of what each metric means.',
            placement: 'auto',
            spotlightClicks: true,
        },
        {
            target: 'button[aria-label="Open upgrade comparison modal"]',
            content: 'Compare different heat pump models side-by-side to see how upgrading would affect your costs.',
            placement: 'bottom',
            spotlightClicks: true,
        },
        {
            target: '#view-mode',
            content: 'Switch between different views: compressor-only energy, total energy with aux heat, or detailed hourly breakdown.',
            spotlightClicks: true,
        },
    ];

    // Ensure all Joyride targets are mounted before starting the tour
    useEffect(() => {
        if (tourActive) {
            const allTargetsMounted = steps.every(step => document.querySelector(step.target));
            if (!allTargetsMounted) {
                const missingTargets = steps
                    .filter(step => !document.querySelector(step.target))
                    .map(step => step.target);
                console.warn('Some Joyride targets are not yet mounted:', missingTargets);
                // Don't prevent tour from starting, just log the warning
                // setTourActive(false);
            }
        }
    }, [tourActive, steps]);

    // Ensure the chart container has a valid width and height
    const chartContainerStyle = {
        minWidth: '300px',
        minHeight: '300px',
        width: '100%',
        height: '100%',
    };

    // Onboarding handlers
    const completeOnboarding = () => {
        localStorage.setItem('hasCompletedOnboarding', 'true');
        setIsFirstTimeUser(false);
        setShowOnboarding(false);
    };

    const handleOnboardingNext = () => {
        if (onboardingStep === 4) {
            completeOnboarding();
        } else {
            setOnboardingStep(prev => prev + 1);
        }
    };

    const handleOnboardingSkip = () => {
        completeOnboarding();
    };

    // Auto-advance onboarding step 1 when location is found
    useEffect(() => {
        if (onboardingStep === 1 && foundLocationName && !forecastLoading && showOnboarding && justFetchedWeather) {
            // Auto-advance after a brief delay so user sees the confirmation
            const timer = setTimeout(() => {
                handleOnboardingNext();
                setJustFetchedWeather(false); // Reset the flag
            }, 1500);
            return () => clearTimeout(timer);
        }
    }, [foundLocationName, forecastLoading, onboardingStep, showOnboarding, justFetchedWeather]);

    // Auto-advance onboarding if Next was clicked before confirming location
    useEffect(() => {
        if (autoAdvanceOnboarding && foundLocationName && !forecastLoading && onboardingStep === 1) {
            handleOnboardingNext();
            setAutoAdvanceOnboarding(false);
        }
    }, [autoAdvanceOnboarding, foundLocationName, forecastLoading, onboardingStep]);

    return (
        <div className="space-y-6 seven-day-cost-forecaster">
            {/* Dashboard Link */}
            <div className="flex justify-end mb-4">
                <DashboardLink />
            </div>
            
            {/* First-Time User Onboarding Overlay */}
            {showOnboarding && (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full p-8 relative dark:border dark:border-gray-700">
                        {/* Skip button */}
                        <button 
                            onClick={handleOnboardingSkip}
                            className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-400 text-sm"
                        >
                            Skip setup
                        </button>

                        {/* Progress indicator */}
                        <div className="flex items-center justify-center gap-2 mb-6">
                            {[1, 2, 3, 4].map(step => (
                                <div 
                                    key={step}
                                    className={`h-2 w-16 rounded-full transition-all ${
                                        step <= onboardingStep ? 'bg-blue-600' : 'bg-gray-200'
                                    }`}
                                />
                            ))}
                        </div>

                        {/* Step 1: Welcome & Location */}
                        {onboardingStep === 1 && (
                            <div className="text-center">
                                <div className="text-6xl mb-4">üè†</div>
                                <h2 className="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-3">
                                    Welcome to Heat Pump Cost Forecaster
                                </h2>
                                <p className="text-lg text-gray-700 dark:text-gray-300 leading-relaxed mb-8">
                                    Let's estimate your heating costs for the next 7 days. We'll keep this simple‚Äîjust 4 quick steps!
                                </p>
                                
                                <div className="bg-blue-50 dark:bg-blue-950 dark:border dark:border-blue-800 rounded-xl p-6 mb-6">
                                    <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">
                                        Step 1: Where do you live?
                                    </h3>
                                    <p className="text-sm md:text-base text-gray-700 dark:text-gray-100 font-medium leading-snug mb-4">
                                        We need your location to get accurate weather data for the forecast
                                    </p>
                                    <input 
                                        type="text" 
                                        value={cityName} 
                                        onChange={e => dispatch({ type: 'SET_LOCATION_FIELD', field: 'cityName', value: e.target.value })} 
                                        placeholder="Enter city, state (e.g., Denver, CO or Atlanta, GA)" 
                                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400"
                                        onKeyDown={e => {
                                            if (e.key === 'Enter' && cityName) {
                                                handleCitySearch();
                                            }
                                        }}
                                    />
                                    <button 
                                        onClick={() => {
                                            handleCitySearch();
                                        }}
                                        disabled={!cityName}
                                        className="btn btn-primary w-full py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {forecastLoading ? 'Loading...' : 'Confirm Location for Utility Cost and weather data'}
                                    </button>
                                    {forecastError && (
                                        <p className="text-red-600 text-sm mt-2">{forecastError}</p>
                                    )}
                                    {foundLocationName && !forecastLoading && (
                                        <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                            <p className="text-green-800 text-sm dark:text-green-400">
                                                ‚úì Found: {foundLocationName}
                                            </p>
                                        </div>
                                    )}
                                </div>

                                <button 
                                    onClick={() => {
                                        if (!foundLocationName && cityName && !forecastLoading) {
                                            setAutoAdvanceOnboarding(true);
                                            handleCitySearch();
                                        } else {
                                            handleOnboardingNext();
                                        }
                                    }}
                                    disabled={!cityName || forecastLoading}
                                    className="btn btn-primary px-8 py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Next ‚Üí
                                </button>
                            </div>
                        )}

                        {/* Step 2: Basic Home Details */}
                        {onboardingStep === 2 && (
                            <div className="text-center">
                                <div className="text-6xl mb-4">üìè</div>
                                <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-3">
                                    Tell us about your home
                                </h2>
                                <p className="text-lg text-gray-700 dark:text-gray-200 font-medium leading-snug mb-8">
                                    Just a few basics so we can estimate your heating needs accurately
                                </p>
                                
                                <div className="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-xl p-6 mb-6 text-left">
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 dark:text-gray-100 mb-2">
                                                Home Size
                                            </label>
                                            <div className="flex items-center gap-4">
                                                <input 
                                                    type="range" 
                                                    min="800" 
                                                    max="4000" 
                                                    step="100" 
                                                    value={squareFeet} 
                                                    onChange={(e) => setSquareFeet(Number(e.target.value))} 
                                                    className="flex-grow"
                                                />
                                                <span className="text-2xl font-bold text-blue-600 dark:text-blue-400 min-w-[120px]">
                                                    {squareFeet.toLocaleString()} sq ft
                                                </span>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                                How well insulated is your home?
                                            </label>
                                            <select 
                                                value={insulationLevel} 
                                                onChange={(e) => setInsulationLevel(Number(e.target.value))} 
                                                className="w-full p-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg text-base"
                                            >
                                                <option value={1.4}>Poor (older home, drafty)</option>
                                                <option value={1.0}>Average (typical home)</option>
                                                <option value={0.65}>Good (well-insulated, newer)</option>
                                            </select>
                                        </div>

                                        <div className="flex gap-3 justify-center">
                                            <button 
                                                onClick={() => setOnboardingStep(1)}
                                                className="btn btn-outline px-6 py-3"
                                            >
                                                ‚Üê Back
                                            </button>
                                            <button 
                                                onClick={handleOnboardingNext}
                                                className="btn btn-primary px-8 py-3 text-lg"
                                            >
                                                Next ‚Üí
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Step 3: Electricity Cost */}
                        {onboardingStep === 3 && (
                            <div className="text-center">
                                <div className="text-6xl mb-4">‚ö°</div>
                                <h2 className="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-3">
                                    Set your electricity cost
                                </h2>
                                <p className="text-lg text-gray-700 dark:text-gray-100 font-medium leading-snug mb-8">
                                    This helps us calculate your weekly cost more accurately. You can change it later under <strong>Electricity Rates</strong>.
                                </p>

                                {stateName && (
                                    <div className="bg-green-50 dark:bg-green-950 border border-green-300 dark:border-green-700 rounded-lg p-4 mb-6">
                                        <p className="text-sm text-green-800 dark:text-green-300">
                                            ‚úì We've pre-filled the average rate for <strong>{stateName}</strong>
                                        </p>
                                    </div>
                                )}

                                <div className="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-xl p-6 mb-6 text-left">
                                    <label className="block text-sm font-semibold text-gray-700 dark:text-gray-100 mb-2">
                                        Cost per kWh
                                    </label>
                                    <div className="flex items-center gap-4">
                                        <input
                                            type="range"
                                            min="0.05"
                                            max="0.50"
                                            step="0.005"
                                            value={utilityCost}
                                            onChange={(e) => setUtilityCost(Number(e.target.value))}
                                            className="flex-grow"
                                        />
                                        <span className="text-2xl font-bold text-blue-600 dark:text-blue-400 min-w-[140px]">
                                            ${utilityCost.toFixed(3)}/kWh
                                        </span>
                                    </div>
                                    <p className="text-xs text-gray-600 dark:text-gray-300 mt-3">
                                        Tip: If you know your exact rate, set it here. Otherwise, we‚Äôll use the best available estimate from your location.
                                    </p>
                                </div>

                                <div className="flex gap-3 justify-center">
                                    <button 
                                        onClick={() => setOnboardingStep(2)}
                                        className="btn btn-outline px-6 py-3"
                                    >
                                        ‚Üê Back
                                    </button>
                                    <button 
                                        onClick={handleOnboardingNext}
                                        className="btn btn-primary px-8 py-3 text-lg"
                                    >
                                        Next ‚Üí
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Step 4: Results Preview & Completion */}
                        {onboardingStep === 4 && (
                            <div className="text-center">
                                <div className="text-6xl mb-4">‚ú®</div>
                                <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-3">
                                    Your forecast is ready!
                                </h2>
                                <p className="text-lg text-gray-700 dark:text-gray-300 mb-6">
                                    Here's what to expect for the next 7 days
                                </p>
                                
                                {weeklyMetrics && (
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl p-6">
                                            <h3 className="text-sm font-semibold text-gray-700 mb-1 uppercase tracking-wide">
                                                Total Energy
                                            </h3>
                                            <div className="flex items-baseline justify-center gap-2">
                                                <p className="text-4xl font-bold text-blue-600">
                                                    {weeklyMetrics.totalEnergy.toFixed(1)}
                                                </p>
                                                <span className="text-lg text-gray-700 dark:text-gray-300">kWh</span>
                                            </div>
                                        </div>
                                        <div className="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-xl p-6">
                                            <h3 className="text-sm font-semibold text-gray-700 mb-1 uppercase tracking-wide">
                                                Total Cost
                                            </h3>
                                            <div className="flex items-baseline justify-center gap-2">
                                                <p className="text-4xl font-bold text-green-600">
                                                    ${weeklyMetrics.totalCost.toFixed(2)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6 text-left">
                                    <p className="text-sm text-gray-700">
                                        üí° <strong>Pro tip:</strong> You can refine this estimate anytime by adjusting your home details, electricity rates, or exploring different scenarios.
                                    </p>
                                </div>

                                <div className="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-5 mb-6 text-left">
                                    <h4 className="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                        <Thermometer size={20} className="text-blue-600" />
                                        Try the Thermostat Slider
                                    </h4>
                                    <p className="text-sm text-gray-700 mb-3">
                                        Now, <strong>drag the slider below to see how changing your thermostat affects your weekly bill</strong>. 
                                        Each degree matters! Set it to your comfort zone and find the perfect balance between cozy and cost-conscious.
                                    </p>
                                    <p className="text-xs text-gray-700 dark:text-gray-300">
                                        The slider updates your forecast instantly‚Äîno need to re-run the calculation.
                                    </p>
                                </div>

                                <div className="flex gap-3 justify-center">
                                    <button 
                                        onClick={() => setOnboardingStep(3)}
                                        className="btn btn-outline px-6 py-3"
                                    >
                                        ‚Üê Back
                                    </button>
                                    <button 
                                        onClick={() => {
                                            handleOnboardingNext();
                                        }}
                                        className="btn btn-outline px-8 py-3 text-lg"
                                    >
                                        Skip Tour
                                    </button>
                                    <button 
                                        onClick={() => {
                                            handleOnboardingNext();
                                            setTimeout(() => setTourActive(true), 500);
                                        }}
                                        className="btn btn-primary px-8 py-3 text-lg"
                                    >
                                        Get Started! üéâ
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}

            <div className="flex items-center justify-between">
                <h2 className="text-2xl font-semibold tracking-tight flex items-center gap-2 bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-brand-400">
                    7-Day Cost Forecaster
                </h2>
                <div className="flex items-center gap-2">
                    {weeklyMetrics && (
                        <span className="badge badge-accent">Forecast Ready</span>
                    )}
                    {!isFirstTimeUser && (
                        <button 
                            onClick={() => {
                                setOnboardingStep(1);
                                setShowOnboarding(true);
                            }}
                            className="text-sm text-blue-600 hover:text-blue-800 underline"
                        >
                            Edit Home Details
                        </button>
                    )}
                </div>
            </div>

            {/* Cost Estimates Section - MOVED TO TOP FOR EMPHASIS */}
            <div className="card card-hover p-6 fade-in">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2 mb-2">
                    <TrendingUp size={24} className="text-green-600 dark:text-green-400" /> 
                    Cost Estimates
                </h2>
                <p className="text-sm text-gray-700 dark:text-gray-300 mb-6">
                    Get accurate 7-day forecasts based on real weather data or test custom scenarios
                </p>
                <div className="flex gap-2 mb-6 border-b">
                    <button onClick={() => dispatch({ type: 'SET_UI_FIELD', field: 'activeTab', value: 'forecast' })} className={`px-4 py-2 font-semibold transition-colors ${activeTab === 'forecast' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'}`}><div className="flex items-center gap-2"><Calendar size={18} />7-Day Forecast</div></button>
                    <button onClick={() => dispatch({ type: 'SET_UI_FIELD', field: 'activeTab', value: 'manual' })} className={`px-4 py-2 font-semibold transition-colors ${activeTab === 'manual' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'}`}><div className="flex items-center gap-2"><Settings size={18} />Custom Scenario</div></button>
                </div>
                {activeTab === 'forecast' && (
                    <div>
                        {/* STEP 1: Configure Your Forecast (Inputs Section) */}
                        <div className="mb-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950 dark:to-indigo-950 rounded-lg border-2 border-blue-200 dark:border-blue-800 shadow-sm">
                            <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-1">Step 1: Configure Your Forecast</h3>
                            <p className="text-sm text-gray-700 dark:text-gray-300 mb-4">Enter your location and home details to get started</p>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
                                        <MapPin size={16} />
                                        Your Location
                                    </label>
                                    <div className="flex flex-wrap items-center gap-2">
                                        <input 
                                            id="city-input"
                                            type="text" 
                                            value={cityName} 
                                            onChange={e => dispatch({ type: 'SET_LOCATION_FIELD', field: 'cityName', value: e.target.value })} 
                                            placeholder="City, State (e.g., Denver, CO)" 
                                            className="p-3 border rounded-lg flex-grow text-base dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400"
                                            onKeyDown={e => e.key === 'Enter' && handleCitySearch()}
                                        />
                                        <button onClick={handleCitySearch} className="btn btn-primary px-6" aria-label="Search city forecast">
                                            Search
                                        </button>
                                        <button onClick={handleLocationRequest} className="btn btn-secondary flex items-center gap-2 px-4" aria-label="Use current location">
                                            <MapPin size={18} /> GPS
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Format: "Chicago, IL" or "Denver, CO"</p>
                                    {foundLocationName && (
                                        <div className="mt-2 p-2 bg-green-100 dark:bg-green-900 rounded border border-green-300 dark:border-green-700">
                                            <p className="text-sm text-green-800 dark:text-green-200">
                                                ‚úì {foundLocationName}
                                            </p>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label htmlFor="elevation" className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
                                        <Mountain size={16} />
                                        Home Elevation
                                        <HelpCircle 
                                            size={14} 
                                            className="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 cursor-help"
                                            title="Higher elevations have thinner air, affecting heat pump efficiency."
                                        />
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input 
                                            id="elevation" 
                                            type="number" 
                                            step="50" 
                                            min="0"
                                            max="15000"
                                            value={homeElevation} 
                                            onChange={e => {
                                                const val = e.target.value === '' ? 0 : Math.max(0, Math.min(15000, Number(e.target.value)));
                                                dispatch({ type: 'SET_LOCATION_FIELD', field: 'homeElevation', value: val });
                                            }} 
                                            placeholder="e.g., 5280" 
                                            className="p-3 border rounded-lg flex-grow text-base dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                        />
                                        <span className="font-semibold text-gray-600 dark:text-gray-300 whitespace-nowrap">ft</span>
                                    </div>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Affects air density and heat pump performance</p>
                                </div>
                            </div>

                            {/* Update Forecast Button */}
                            <div className="mt-6 flex gap-3">
                                <button 
                                    onClick={handleCitySearch}
                                    disabled={!cityName || forecastLoading}
                                    className="flex-1 btn btn-primary py-3 text-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {forecastLoading ? 'Calculating...' : 'Update Forecast'}
                                </button>
                            </div>
                        </div>

                        {/* Loading State */}
                        {forecastLoading && (
                            <div className="text-center py-8">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                <p className="text-gray-600 mt-2">Loading location and weather data...</p>
                            </div>
                        )}
                        {forecastError && <p className="text-red-600 font-semibold p-4 bg-red-50 rounded border border-red-200">{forecastError}</p>}
                        
                        {weeklyMetrics && !forecastLoading && !forecastError && (
                            <div>
                                {/* Prominent Thermostat Slider - Core Budgeting Feature */}
                                <div className="card card-hover p-6 mb-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900 dark:to-indigo-900 border-2 border-blue-300 dark:border-blue-700 shadow-md">
                                    <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2 flex items-center gap-2">
                                        <Thermometer size={24} className="text-blue-600 dark:text-blue-400" />
                                        Your Weekly Thermostat Setting
                                    </h2>
                                    <p className="text-sm text-gray-700 dark:text-gray-300 mb-4">
                                        Drag the slider below to see how changing your temperature affects your weekly heating cost
                                    </p>
                                    <div className="flex items-center gap-4">
                                        <span className="text-sm font-semibold text-gray-700 dark:text-gray-300 min-w-fit">60¬∞F</span>
                                        <input 
                                            type="range" 
                                            min="60" 
                                            max="78" 
                                            value={indoorTemp} 
                                            onChange={(e) => setIndoorTemp(Number(e.target.value))} 
                                            className="flex-grow h-3 cursor-pointer" 
                                        />
                                        <span className="text-sm font-semibold text-gray-700 dark:text-gray-300 min-w-fit">78¬∞F</span>
                                    </div>
                                    <div className="text-center mt-4">
                                        <p className="text-5xl font-bold text-blue-600 dark:text-blue-400">{indoorTemp}¬∞F</p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Set for your forecast</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div id="weekly-energy-card" className="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-950 border-2 border-blue-300 dark:border-blue-700 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                                        <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 uppercase tracking-wide">Total Energy</h3>
                                        <div className="flex items-baseline gap-2">
                                            <p className="text-5xl font-bold text-blue-600 dark:text-blue-400">{(breakdownView === 'withAux' ? weeklyMetrics.summary.reduce((acc, d) => acc + d.energyWithAux, 0) : weeklyMetrics.totalEnergy).toFixed(1)}</p>
                                            <span className="text-lg text-gray-600 dark:text-gray-300 font-medium">kWh</span>
                                        </div>
                                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-2">Next 7 days</p>
                                    </div>
                                    <div id="weekly-cost-card" className="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-950 border-2 border-green-300 dark:border-green-700 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                                        <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 uppercase tracking-wide">Total Cost</h3>
                                        <div className="flex items-baseline gap-2">
                                            <p className="text-5xl font-bold text-green-600 dark:text-green-400">${(breakdownView === 'withAux' ? weeklyMetrics.totalCostWithAux : weeklyMetrics.totalCost).toFixed(2)}</p>
                                        </div>
                                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-2">Estimated for 7 days</p>
                                        <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">@ ${utilityCost.toFixed(3)}/kWh <button onClick={() => dispatch({ type: 'SET_UI_FIELD', field: 'activeTab', value: 'forecast' })} className="italic text-blue-600 dark:text-blue-400 hover:underline cursor-pointer">(edit in Electricity Rates)</button></p>
                                    </div>
                                </div>

                                {/* ROI Widget */}
                                {roiData && roiData.annualSavings > 0 && (
                                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-300 rounded-lg p-4 mb-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <TrendingDown size={20} className="text-purple-600" />
                                            <h3 className="text-sm font-semibold text-gray-800">Annual Savings vs Gas Heat</h3>
                                        </div>
                                        <div className="flex items-baseline gap-3">
                                            <p className="text-3xl font-bold text-purple-700">${roiData.annualSavings.toFixed(0)}/yr</p>
                                            <p className="text-sm text-gray-600">({roiData.savingsPercent.toFixed(0)}% lower cost)</p>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">Heat pump: ${roiData.annualHeatPumpCost.toFixed(0)}/yr ‚Ä¢ Gas heat: ${roiData.annualGasCost.toFixed(0)}/yr</p>
                                    </div>
                                )}

                                {/* Aux Heat Alert */}
                                {auxPercentage > 30 && (
                                    <div className="bg-orange-50 border-l-4 border-orange-400 p-4 mb-4">
                                        <div className="flex items-start">
                                            <AlertTriangle size={20} className="text-orange-600 mt-0.5 mr-2 flex-shrink-0" />
                                            <div className="flex-1">
                                                <h4 className="text-sm font-semibold text-orange-800">High Auxiliary Heat Usage ({auxPercentage.toFixed(0)}%)</h4>
                                                <p className="text-xs text-orange-700 mt-1">
                                                    Your system is relying heavily on expensive backup heat. Consider upgrading to a larger/more efficient system or improving insulation to reduce costs.
                                                </p>
                                                <button onClick={() => setShowUpgradeModal(true)} className="mt-2 px-3 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700">
                                                    See Upgrade Options ‚Üí
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Share & Upgrade Buttons */}
                                <div className="flex flex-wrap gap-3 mb-4">
                                    <button onClick={handleShare} className="btn btn-outline" aria-label="Copy shareable forecast URL">
                                        <Share2 size={18} /> Share Forecast
                                    </button>
                                    <button onClick={() => setShowUpgradeModal(true)} className="btn btn-primary" aria-label="Open upgrade comparison modal">
                                        <TrendingUp size={18} /> Compare Upgrade
                                    </button>
                                </div>
                                {shareMessage && (
                                    <p className="text-sm text-green-600 mb-4">{shareMessage}</p>
                                )}
                                
                                {/* Collapsible Daily Breakdown */}
                                <div className="border rounded-lg dark:border-gray-700 mb-6">
                                    <button 
                                        onClick={() => setShowDailyBreakdown(!showDailyBreakdown)}
                                        className="w-full flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-750 transition-colors"
                                    >
                                        <h3 className="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                            <span>{showDailyBreakdown ? '‚ñº' : '‚ñ∂'}</span> Daily Breakdown
                                        </h3>
                                        <span className="text-sm text-gray-600 dark:text-gray-400">Detailed daily forecast</span>
                                    </button>
                                    
                                    {showDailyBreakdown && (
                                        <div className="p-4 border-t dark:border-gray-700">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                    <label htmlFor="view-mode" className="text-sm font-medium text-gray-700 dark:text-gray-300">View Mode:</label>
                                                    <select id="view-mode" value={breakdownView} onChange={(e) => dispatch({ type: 'SET_UI_FIELD', field: 'breakdownView', value: e.target.value })} className="p-2 border rounded-lg text-sm font-semibold bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                                                        <option value="withAux">With Aux Heat</option>
                                                        <option value="noAux">Heat Pump Only</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <p className="text-xs text-gray-700 dark:text-gray-300 mb-3 italic bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                                                <strong>With Aux Heat:</strong> shows minimum indoor temp when supplemental electric resistance heat is allowed (aux maintains setpoint when heat pump can't meet load). 
                                                <br />
                                                <strong>Heat Pump Only:</strong> shows minimum indoor temp if only the heat pump operates (no aux backup).
                                            </p>
                                            <DailyBreakdownTable summary={weeklyMetrics.summary} indoorTemp={indoorTemp} viewMode={breakdownView} />
                                        </div>
                                    )}
                                </div>
                                {/* --- COLLAPSIBLE ELEVATION ANALYSIS GRAPH --- */}
                                {elevationCostData && (
                                    <div className="border rounded-lg dark:border-gray-700">
                                        <button 
                                            onClick={() => setShowElevationAnalysis(!showElevationAnalysis)}
                                            className="w-full flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-750 transition-colors"
                                        >
                                            <h3 className="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                                <span>{showElevationAnalysis ? '‚ñº' : '‚ñ∂'}</span>
                                                <AreaChart size={20}/> Cost vs. Elevation Analysis
                                            </h3>
                                            <span className="text-sm text-gray-600 dark:text-gray-400">For mountainous regions</span>
                                        </button>

                                        {showElevationAnalysis && (
                                            <div className="p-4 border-t dark:border-gray-700">
                                                <p className="text-sm text-gray-700 dark:text-gray-300 mb-4">
                                                    Especially useful for people in mountainous regions. See how changing your elevation affects your heating costs.
                                                </p>
                                                <div style={{ width: '100%', height: window.innerWidth < 640 ? 250 : 300 }}>
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <LineChart
                                                            data={elevationCostData}
                                                            margin={{ top: 5, right: window.innerWidth < 640 ? 5 : 30, left: window.innerWidth < 640 ? 5 : 20, bottom: 5 }}
                                                        >
                                                            <CartesianGrid strokeDasharray="3 3" />
                                                            <XAxis 
                                                                dataKey="elevation" 
                                                                type="number"
                                                                domain={["dataMin", "dataMax"]}
                                                                label={{ value: 'Elevation (ft)', position: 'insideBottom', offset: -5, style: { fontSize: window.innerWidth < 640 ? 12 : 14 } }}
                                                                tickFormatter={(tick) => tick.toLocaleString()}
                                                                tick={{ fontSize: window.innerWidth < 640 ? 10 : 12 }}
                                                            />
                                                            <YAxis 
                                                                label={{ value: '7-Day Cost', angle: -90, position: 'insideLeft', style: { fontSize: window.innerWidth < 640 ? 12 : 14 } }}
                                                                tickFormatter={(tick) => `$${tick}`}
                                                                tick={{ fontSize: window.innerWidth < 640 ? 10 : 12 }}
                                                            />
                                                            <Tooltip formatter={(value) => `$${value}`} labelFormatter={(label) => `${label.toLocaleString()} ft`} />
                                                            <Legend verticalAlign="top" height={36} wrapperStyle={{ fontSize: window.innerWidth < 640 ? 12 : 14 }}/>
                                                            <Line type="monotone" dataKey="cost" stroke="#2563eb" strokeWidth={2} name="Estimated 7-Day Cost"/>
                                                            <ReferenceDot x={homeElevation} y={(breakdownView === 'withAux' ? weeklyMetrics.totalCostWithAux : weeklyMetrics.totalCost)} r={5} fill="#dc2626" stroke="white"  />
                                                        </LineChart>
                                                    </ResponsiveContainer>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                            </div>
                        )}

                    </div>
                )}
                
                {activeTab === 'manual' && (
                    <div>
                        <p className="text-sm text-gray-600 mb-4">Test a specific temperature and humidity scenario.</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Outdoor Temperature</label><input type="range" min="-10" max="70" step="1" value={manualTemp} onChange={(e) => dispatch({ type: 'SET_MANUAL_FIELD', field: 'manualTemp', value: Number(e.target.value) })} className="w-full mb-1" /><div className="text-center"><span className="text-3xl font-bold text-blue-600">{manualTemp}¬∞F</span></div></div>
                            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Relative Humidity</label><input type="range" min="0" max="100" step="1" value={manualHumidity} onChange={(e) => dispatch({ type: 'SET_MANUAL_FIELD', field: 'manualHumidity', value: Number(e.target.value) })} className="w-full mb-1" /><div className="text-center"><span className="text-3xl font-bold text-blue-600">{manualHumidity}%</span></div></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-6"><h3 className="text-sm font-semibold text-gray-700 mb-2">Daily Energy Use</h3><p className="text-4xl font-bold text-blue-600">{manualDayMetrics.dailyEnergy.toFixed(1)}</p><p className="text-sm text-gray-600">kWh per day</p></div>
                            <div className="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-lg p-6"><h3 className="text-sm font-semibold text-gray-700 mb-2">Daily Cost</h3><p className="text-4xl font-bold text-green-600">${manualDayMetrics.dailyCost.toFixed(2)}</p><p className="text-sm text-gray-600">per day</p></div>
                        </div>
                    </div>
                )}
            </div>

            {/* Building Heat Loss Section */}
            <div className="card card-hover p-6 fade-in" role="region" aria-labelledby="rates-section-heading">
                <div className="flex items-center justify-between mb-4 cursor-pointer" onClick={() => setBuildingExpanded(!buildingExpanded)}>
                    <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                        <Home size={20} /> Building Heat Loss
                        {buildingExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                    </h2>
                    <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                        <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Use:</span>
                        <select value={useCalculatedFactor ? 'calculated' : 'manual'} onChange={(e) => dispatch({ type: 'SET_UI_FIELD', field: 'useCalculatedFactor', value: e.target.value === 'calculated' })} className="p-2 border rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" disabled={!heatLossFactor}>
                            <option value="manual">Manual Estimator</option>
                            <option value="calculated">Calculated Factor</option>
                        </select>
                        {!heatLossFactor && (
                            <span className="text-xs text-gray-500 dark:text-gray-400 italic">
                                (automatic calculation requires <Link to="/performance-analyzer" className="text-blue-500 dark:text-blue-400 hover:underline">Analyzer tab</Link> data)
                            </span>
                        )}
                    </div>
                </div>
                {buildingExpanded && (
                    <>
                        {!useCalculatedFactor ? (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                                    <div><label className="block text-sm font-semibold text-gray-700 dark:text-gray-300">Square Footage</label><input type="range" min="800" max="4000" step="100" value={squareFeet} onChange={(e) => setSquareFeet(Number(e.target.value))} className="w-full" /><span className="font-bold text-gray-900 dark:text-gray-100">{squareFeet.toLocaleString()} sq ft</span></div>
                                    <div><label className="block text-sm font-semibold text-gray-700 dark:text-gray-300">Ceiling Height</label><input type="range" min="7" max="20" step="1" value={ceilingHeight} onChange={(e) => setCeilingHeight(Number(e.target.value))} className="w-full" /><span className="font-bold text-gray-900 dark:text-gray-100">{ceilingHeight} ft</span></div>
                                    <div><label className="block text-sm font-semibold text-gray-700 dark:text-gray-300">Insulation</label><select value={insulationLevel} onChange={(e) => setInsulationLevel(Number(e.target.value))} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"><option value={1.4}>Poor</option><option value={1.0}>Average</option><option value={0.65}>Good</option></select></div>
                                    <div><label className="block text-sm font-semibold text-gray-700 dark:text-gray-300">Home Shape</label><select value={homeShape} onChange={(e) => setHomeShape(Number(e.target.value))} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"><option value={1.3}>Cabin / A-Frame</option><option value={1.15}>Ranch</option><option value={1.0}>Average</option><option value={0.9}>2-Story</option></select></div>
                                </div>
                                <div className="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                                    <p className="text-sm text-gray-900 dark:text-gray-100">
                                        <strong>Calculated Heat Loss:</strong> {heatLoss.toLocaleString()} BTU/hr at 70¬∞F ŒîT ({(heatLoss / 70).toFixed(1)} BTU/hr/¬∞F)
                                    </p>
                                    {heatLoss > capacity * 1000 && (
                                        <p className="text-xs text-orange-600 dark:text-orange-400 mt-1">
                                            ‚ö†Ô∏è Heat loss exceeds system capacity ‚Äî expect high aux heat usage in cold weather
                                        </p>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="p-4 bg-blue-50 dark:bg-blue-950 rounded-lg border border-blue-200 dark:border-blue-800">
                                <p className="font-semibold text-gray-900 dark:text-gray-100">Using Calculated Heat Loss Factor:</p>
                                <p className="text-2xl font-bold text-blue-700 dark:text-blue-400">{heatLossFactor ? heatLossFactor.toFixed(1) : 'N/A'} <span className="text-lg font-normal text-gray-700 dark:text-gray-300">BTU / hr / ¬∞F</span></p>
                                {!heatLossFactor && <p className="text-xs text-gray-700 dark:text-gray-300">No factor available. Please use the Performance Analyzer tool first.</p>}
                            </div>
                        )}
                    </>
                )}
            </div>

            {/* Rates (TOU) Editor */}
            <div className="card card-hover p-6 fade-in">
                <div className="flex items-center justify-between mb-4 cursor-pointer" onClick={() => setRatesExpanded(!ratesExpanded)}>
                    <h2 id="rates-section-heading" className="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                        <DollarSign size={20} /> Electricity Rates
                        {ratesExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                    </h2>
                </div>
                {ratesExpanded && (
                    <>
                        <p className="text-sm text-gray-700 dark:text-gray-300 mb-4">
                            Configure your electricity rates for accurate cost estimates. Use a flat rate or define time-of-use periods for more precision.
                        </p>

                        <div className="mb-4 p-4 bg-blue-50 dark:bg-blue-950 rounded-lg border border-blue-100 dark:border-blue-800">
                            <label className="block text-sm font-semibold text-gray-800 dark:text-gray-100 mb-2">
                                Your Electricity Rate
                            </label>
                            <p className="text-xs text-gray-600 dark:text-gray-300 mb-3">
                                Not sure? The average US rate is about $0.15/kWh
                            </p>
                            <div className="flex items-center gap-2">
                                <span className="text-lg">$</span>
                                <input 
                                    type="range" 
                                    min="0.05" 
                                    max="0.50" 
                                    step="0.001" 
                                    value={utilityCost} 
                                    onChange={(e) => setUtilityCost(Number(e.target.value))} 
                                    className="flex-grow"
                                />
                                <span className="text-2xl font-bold text-green-600 min-w-[100px]">
                                    ${utilityCost.toFixed(3)}/kWh
                                </span>
                            </div>
                        </div>
                        
                        {ui.error && (
                            <div className="p-3 mb-4 bg-red-100 border border-red-400 text-red-700 rounded">
                                <strong>Error:</strong> {ui.error}
                            </div>
                        )}
                        {ui.warning && (
                            <div className="p-3 mb-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded">
                                <strong>Warning:</strong> {ui.warning}
                            </div>
                        )}
                    </>
                )}

                {ratesExpanded && (
                    <>
                        {/* Advanced Options Toggle */}
                        <button 
                            onClick={() => setShowAdvancedRates(!showAdvancedRates)}
                            className="mb-4 px-4 py-2 bg-blue-50 dark:bg-blue-900 hover:bg-blue-100 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 rounded-lg font-semibold flex items-center gap-2 transition-colors"
                        >
                            {showAdvancedRates ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                            Auto-Fetch Rates (Advanced)
                        </button>

                        {showAdvancedRates && (
                            <div className="mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                                <p className="text-sm text-gray-700 dark:text-gray-300 mb-3">
                                    <strong>Why use API keys?</strong> For live, accurate electricity rates in your area based on your utility provider. This is optional‚Äîyou can use a manual flat rate instead.
                                </p>
                                
                                <label className="block text-sm font-semibold mb-1 text-gray-800 dark:text-gray-100">NREL API Key</label>
                                <div className="flex flex-wrap items-center gap-2">
                                    <input 
                                        type="password" 
                                        value={apiKey} 
                                        onChange={e => setApiKey(e.target.value)} 
                                        placeholder="Enter your free NREL API key" 
                                        className="p-2 border rounded-lg flex-grow dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                        disabled={ratesLoading}
                                    />
                                </div>
                                <p className="text-xs text-gray-700 dark:text-gray-300 mt-1">Get a free key from the <a href="https://developer.nrel.gov/signup/" target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">NREL Developer Network</a>.</p>
                                
                                <label className="block text-sm font-semibold mb-1 mt-3 text-gray-800 dark:text-gray-100">EIA API Key (for state-average fallback)</label>
                                <div className="flex flex-wrap items-center gap-2">
                                    <input 
                                        type="password" 
                                        value={eiaApiKey} 
                                        onChange={e => setEiaApiKey(e.target.value)} 
                                        placeholder="Enter your free EIA API key" 
                                        className="p-2 border rounded-lg flex-grow dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                        disabled={ratesLoading}
                                    />
                                </div>
                                <p className="text-xs text-gray-700 dark:text-gray-300 mt-1">Get a free key from the <a href="https://www.eia.gov/opendata/register.php" target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">EIA Open Data portal</a>.</p>

                                <div className="mt-4">
                                    <button onClick={handleFetchRates} className="btn btn-primary" aria-label="Fetch rates for location" disabled={ratesLoading}>
                                        {ratesLoading ? 'Fetching...' : 'Fetch Rates'}
                                    </button>
                                </div>

                                {utilityInfo.name && (
                                    <div className="mt-3 p-3 bg-white dark:bg-gray-700 rounded border dark:border-gray-600">
                                        <p className="text-sm text-gray-900 dark:text-gray-100">
                                            <strong>Utility Found:</strong> {utilityInfo.url ? <a href={utilityInfo.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">{utilityInfo.name}</a> : utilityInfo.name}
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                    </>
                )}
            </div>


            {/* System & Utilities Section */}
            <div className="card card-hover p-6 fade-in">
                <div className="flex items-center justify-between mb-4 cursor-pointer" onClick={() => setSystemExpanded(!systemExpanded)}>
                    <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                        <Settings size={20} /> System & Utilities
                        {systemExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                    </h2>
                </div>
                {systemExpanded && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">System Capacity</label><select value={capacity} onChange={(e) => dispatch({ type: 'SET_UI_FIELD', field: 'capacity', value: Number(e.target.value) })} className="w-full px-3 py-2 border rounded-lg font-semibold dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">{Object.entries(capacities).map(([btu, ton]) => (<option key={btu} value={btu}>{btu}k BTU ({ton} tons)</option>))}</select></div>
                        <div><label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Efficiency (SEER2)</label><select value={efficiency} onChange={(e) => dispatch({ type: 'SET_UI_FIELD', field: 'efficiency', value: Number(e.target.value) })} className="w-full px-3 py-2 border rounded-lg font-semibold dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">{[14, 15, 16, 17, 18, 19, 20, 21, 22].map(seer => (<option key={seer} value={seer}>{seer} SEER2</option>))}</select></div>
                    </div>
                )}
            </div>

            {/* Upgrade Scenario Modal */}
            {showUpgradeModal && upgradeScenario && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowUpgradeModal(false)} role="dialog" aria-modal="true" aria-labelledby="upgrade-modal-title">
                    <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h2 id="upgrade-modal-title" className="text-2xl font-bold text-gray-800">Upgrade Scenario Comparison</h2>
                                <button onClick={() => setShowUpgradeModal(false)} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div className="border-2 border-gray-300 rounded-lg p-4">
                                    <h3 className="font-semibold text-gray-700 mb-2">Current System</h3>
                                    <p className="text-sm text-gray-600">Capacity: <span className="font-bold">{capacity}k BTU ({tons} tons)</span></p>
                                    <p className="text-sm text-gray-600">Efficiency: <span className="font-bold">{efficiency} SEER2</span></p>
                                    <div className="mt-3 pt-3 border-t">
                                        <p className="text-2xl font-bold text-blue-600">${upgradeScenario.currentCost.toFixed(2)}</p>
                                        <p className="text-xs text-gray-500">7-day cost</p>
                                    </div>
                                </div>
                                
                                <div className="border-2 border-purple-400 bg-purple-50 rounded-lg p-4">
                                    <h3 className="font-semibold text-purple-800 mb-2">Upgraded System</h3>
                                    <p className="text-sm text-purple-700">Capacity: <span className="font-bold">{upgradeScenario.capacity}k BTU ({upgradeScenario.tons} tons)</span></p>
                                    <p className="text-sm text-purple-700">Efficiency: <span className="font-bold">{upgradeScenario.efficiency} SEER2</span></p>
                                    <div className="mt-3 pt-3 border-t border-purple-300">
                                        <p className="text-2xl font-bold text-purple-700">${upgradeScenario.upgradedCost.toFixed(2)}</p>
                                        <p className="text-xs text-purple-600">7-day cost</p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-green-50 border border-green-300 rounded-lg p-4 mb-4">
                                <h4 className="font-semibold text-green-800 mb-2">Projected Savings</h4>
                                <p className="text-3xl font-bold text-green-700">
                                    ${(upgradeScenario.currentCost - upgradeScenario.upgradedCost).toFixed(2)}/week
                                </p>
                                <p className="text-sm text-green-600 mt-1">
                                    ‚âà ${((upgradeScenario.currentCost - upgradeScenario.upgradedCost) * (365/7)).toFixed(0)}/year
                                    {upgradeScenario.currentCost > 0 && ` (${((1 - upgradeScenario.upgradedCost / upgradeScenario.currentCost) * 100).toFixed(0)}% reduction)`}
                                </p>
                            </div>

                            {upgradeScenario.metrics && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700 mb-2">Upgraded System Weekly Summary</h4>
                                    <div className="text-sm space-y-1">
                                        <p>Total Energy: <span className="font-bold">{upgradeScenario.metrics.summary.reduce((acc, d) => acc + d.energyWithAux, 0).toFixed(1)} kWh</span></p>
                                        <p>Aux Heat Energy: <span className="font-bold">{upgradeScenario.metrics.summary.reduce((acc, d) => acc + d.auxEnergy, 0).toFixed(1)} kWh</span></p>
                                    </div>
                                </div>
                            )}

                            <div className="mt-6 pt-4 border-t">
                                <p className="text-xs text-gray-500 italic">
                                    Note: Savings estimate based on current 7-day forecast. Actual savings vary with weather, usage patterns, and installation quality.
                                    Consult a qualified HVAC professional for detailed assessment and installation costs.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            <button onClick={() => setTourActive(true)} className="btn btn-primary mb-4" id="tour-button">
                <span className="flex items-center gap-2">
                    <HelpCircle size={18} />
                    Show Feature Tour
                </span>
            </button>
            <Joyride
                steps={steps}
                run={tourActive}
                continuous
                showSkipButton
                showProgress
                scrollToFirstStep
                disableOverlayClose
                spotlightClicks
                spotlightPadding={8}
                floaterProps={{
                    disableAnimation: false,
                    styles: {
                        floater: {
                            filter: 'drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3))',
                        },
                        arrow: {
                            length: 12,
                            spread: 16,
                        },
                    },
                }}
                styles={{
                    options: {
                        primaryColor: '#3b82f6',
                        zIndex: 10000,
                        arrowColor: '#fff',
                    },
                    overlay: {
                        backgroundColor: 'rgba(0, 0, 0, 0.6)',
                    },
                    spotlight: {
                        backgroundColor: 'transparent',
                        border: '3px solid #3b82f6',
                        borderRadius: '8px',
                        boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 20px rgba(59, 130, 246, 0.5)',
                    },
                    tooltip: {
                        fontSize: '15px',
                        padding: '16px',
                        borderRadius: '12px',
                        boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
                        maxWidth: '90vw',
                        '@media (min-width: 640px)': {
                            fontSize: '14px',
                            padding: '20px',
                            maxWidth: '420px',
                        },
                    },
                    tooltipContainer: {
                        textAlign: 'left',
                    },
                    tooltipContent: {
                        padding: '10px 0',
                        lineHeight: '1.5',
                    },
                    tooltipTitle: {
                        fontSize: '16px',
                        marginBottom: '8px',
                        '@media (min-width: 640px)': {
                            fontSize: '15px',
                        },
                    },
                    tooltipFooter: {
                        marginTop: '16px',
                    },
                    buttonNext: {
                        backgroundColor: '#3b82f6',
                        fontSize: '15px',
                        padding: '12px 24px',
                        borderRadius: '8px',
                        fontWeight: '600',
                        '@media (min-width: 640px)': {
                            fontSize: '14px',
                            padding: '10px 20px',
                        },
                    },
                    buttonBack: {
                        color: '#3b82f6',
                        fontSize: '15px',
                        fontWeight: '600',
                        marginRight: '12px',
                        '@media (min-width: 640px)': {
                            fontSize: '14px',
                        },
                    },
                    buttonSkip: {
                        color: '#6b7280',
                        fontSize: '14px',
                    },
                }}
                locale={{
                    back: 'Back',
                    close: 'Close',
                    last: 'Finish',
                    next: 'Next',
                    skip: 'Skip Tour',
                }}
                callback={(data) => {
                    const { status, action } = data;
                    if (status === 'finished' || status === 'skipped') {
                        setTourActive(false);
                    }
                    // Log tour progress for debugging
                    console.log('Tour event:', { status, action, step: data.index });
                }}
            />
        </div>
    );
};

export default SevenDayCostForecaster;
